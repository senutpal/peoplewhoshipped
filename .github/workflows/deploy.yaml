# =============================================================================
# Deployment Workflow - Builds and Deploys Leaderboard Static Site
# =============================================================================
#
# This workflow is triggered after the scraper workflow completes:
# 1. Downloads the leaderboard-data artifact from the scraper run
# 2. Imports data into PGlite database
# 3. Builds the Next.js static site
# 4. Deploys to GitHub Pages
#
# Trigger: Runs automatically when scraper workflow completes successfully
# Manual: Can be triggered manually to redeploy with latest data
#
# =============================================================================

name: Deploy

on:
  # Trigger when scraper workflow completes
  workflow_run:
    workflows: ["Scraper"]
    types:
      - completed
  
  # Manual trigger for redeployment
  workflow_dispatch:

# Prevent multiple deployments from conflicting
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

# Permissions required for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    # Only run if scraper succeeded (or manual trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    env:
      # Database path for PGlite
      PGLITE_DB_PATH: ${{ github.workspace }}/pglite-db
      
      # Data directory path
      LEADERBOARD_DATA_PATH: ${{ github.workspace }}/data

    steps:
      # =========================================================================
      # Setup Steps
      # =========================================================================
      
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install

      # =========================================================================
      # Download Scraped Data Artifact
      # =========================================================================
      
      - name: Download Leaderboard Data Artifact
        uses: actions/download-artifact@v4
        with:
          name: leaderboard-data
          path: data/
          # Get artifact from the triggering workflow run
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        # Continue if artifact not found (use existing data in repo)
        continue-on-error: true

      - name: Verify Data Directory
        run: |
          echo "=== Data Directory Contents ==="
          ls -la data/ || echo "No data directory"
          echo "=== GitHub Activities ==="
          ls -la data/github/activities/ 2>/dev/null || echo "No GitHub activities"
          echo "=== Slack Activities ==="
          ls -la data/slack/activities/ 2>/dev/null || echo "No Slack activities"

      # =========================================================================
      # Database Setup & Data Import
      # =========================================================================
      
      - name: Prepare Database
        run: bun run db:prepare

      - name: Import Data to Database
        run: bun run db:import

      # =========================================================================
      # Build Static Site
      # =========================================================================
      
      - name: Build Next.js Static Site
        run: bun run build
        working-directory: apps/web

      - name: Verify Build Output
        run: |
          echo "=== Build Output ==="
          ls -la apps/web/out/ || echo "No output directory"
          echo "=== Total Files ==="
          find apps/web/out -type f | wc -l

      # =========================================================================
      # Deploy to GitHub Pages
      # =========================================================================
      
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: apps/web/out

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Site URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
